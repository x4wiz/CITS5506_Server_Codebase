{% extends "base.html" %}
{% block title %}Index{% endblock %}
{% block head %}
	{{ super() }}
	<style type="text/css">
      .important {
          color: #336699;
      }
	</style>
{% endblock %}
{% block content %}
	<div class="container mx-auto px-4 flex justify-center">
		<div class="m-4 p-6 shadow rounded bg-gray-50">

			<h1 class="text-5xl">Air quality monitor</h1>

			<div id="latest_data" class="p-2 border-1 shadow m-2">
				<table class="p-2 text-xl">
					<tr>
						<td>
							<p>Temperature C: </p>
						</td>
						<td class="pl-4">
							<p id="temperature_c">
						</td>
					</tr>
					<tr>
						<td>
							<p>Humidity:</p>
						</td>
						<td class="pl-4">
							<p id="humidity"></p>
						</td>
					</tr>
					<tr>
						<td>
							<p>CO2:</p>
						</td>
						<td class="pl-4">
							<p id="co2"></p>
						</td>
					</tr>
					<tr>
						<td>
							<p>tVOC:</p>
						</td>
						<td class="pl-4">
							<p id="tvoc"></p>
						</td>
					</tr>
					<tr>
						<td>
							<p>Date:</p>

						</td>
						<td class="pl-4">
							<p id="reading_date"></p>
						</td>
					</tr>
					<tr>
						<td>
							<p>Time: </p>
						</td>
						<td class="pl-4">
							<p id="reading_time"></p>
						</td>
					</tr>

				</table>
				<div class="flex flex-col items-center border-2 p-2 m-2 bg-yellow-300
				text-center
				hidden"
				     id='minor-alert'>
					<p>CO2 levels raised above 1000 ppm</p>
					<button class="border-2 p-2 m-2 bg-yellow-100"
					        onclick="stop_alarm()">Turn off the
					                                           alert</button>
				</div>
			</div>

			<div id="controls" class="border-1 shadow m-2 p-2 mt-5">
				<button type="button" onclick="get_data()" class="border-2 p-2
			m-2 hover:bg-gray-50 text-l">Update
				                           once
				</button>
				<button id = "const_upd" onclick="live_data()"
				        class="border-2 p-2
			m-2  hover:bg-gray-50 text-l">
					Constant update
				</button>
				<br>
				<div>
					<label for="readings_interval" class="p-2 m-2">Set readings
					                                               interval in
					                                               seconds</label><br>
					<input class="border-2 p-2
			m-2 hover:bg-gray-50 text-l" type="number" min="3"
					       id="readings_interval"><br>
					<button onclick="set_interval()" class="border-2 p-2
			m-2 text-l hover:bg-gray-50">Set interval
					</button>
					<button onclick="show_alert()">Show alert</button>
					<div class="flex flex-row p-2 text-xl">
						<p class="">Current interval (sec): </p>
						<p id="cur_interval" class="pl-4">10</p>
					</div>
				</div>
			</div>
		</div>


		<script>
        {#let base_path = 'https://smart-air-quality.herokuapp.com/api/v1'#}
        //remote
        base_path = 'http://192.168.1.127:5000/api/v1' //local
        let live_update_on = false
        let updating

        const set_interval = () => {
            let interval = document.getElementById("readings_interval").value
            $.ajax({
                url: `${base_path}/set_readings_interval`,
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    interval
                })
            })
            console.log(interval)
        }

        const get_settings = () => {
            $.ajax({
                url: `${base_path}/get_settings`,
                type: "GET",
                contentType: "application/json",
            }).done(data => {
                console.log(data)
                document.getElementById("cur_interval").innerText = data
		                .interval
		            console.log(!data.stop_alarm && data.alarm)
		            if (!data.stop_alarm && data.alarm) show_alert()
		            if (!data.alarm) hide_alert()
            })

        }

        const show_alert = () => {
            document.getElementById("minor-alert").classList.remove("hidden")
        }

        const hide_alert = () => {
            document.getElementById("minor-alert").classList.add("hidden")
        }

        const stop_alarm = () => {
            hide_alert()
            $.ajax({
                url: `${base_path}/stop_alarm`,
                type: "POST",
                contentType: "application/json",
		            data: JSON.stringify({
                    alarm: false
                })
            })
        }

        const live_data = () => {
            if (!live_update_on) {
                live_update_on = true
                updating = setInterval(get_data, 1000 * 3)
		            document.getElementById("const_upd").classList.add("bg-green-100")
            } else {
                live_update_on = false
		            clearTimeout(updating)
		            document.getElementById("const_upd").classList.remove("bg-green-100")
            }

        }

        const get_data = async () => {
            $.ajax({
                url: `${base_path}/get_readings`,
                type: "GET",
                contentType: "application/json",
            }).done(data => {

                let data_arr = data.split(" ")
                console.log(data_arr)
                let date = `${data_arr[4]} ${data_arr[3]} ${data_arr[6]}`
                document.getElementById("temperature_c").innerText =
		                data_arr[0] + ' C'
                document.getElementById("humidity").innerText = data_arr[1]
		                + ' %'
                document.getElementById("reading_date").innerText = date
                document.getElementById("reading_time").innerText =
                    data_arr[5].toString()
		            document.getElementById("co2").innerText =
                    data_arr[7].toString() + ' ppm'
		            document.getElementById("tvoc").innerText =
                    data_arr[8].toString() + ' ppb'


            });
        }
        window.onload = () => {
            setInterval(get_settings, 1000 * 3)
        }
		</script>
	</div>
	{#	<script src="{{ url_for('static', filename='js/get_data.js') }}"></script>#}
{% endblock %}